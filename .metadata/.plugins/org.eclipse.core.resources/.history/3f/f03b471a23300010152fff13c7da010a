/*
 * state_machine.c
 *
 *  Created on: May 11, 2025
 *      Author: axeel
 */

#include "state_machine.h"
#include <string.h>
#include <stdio.h>
#include <stdlib.h>

static bool changed = true;
static char str[14];
static uint8_t len;


static uint32_t timestamp;
static uint32_t timestamp_display_s;
static uint32_t countdown_start;

static char* set_alert_time = "****";
static char* set_new_pin = "####";
static char* menage_number = "#*#*";
static char pin[9] = "";
static char numbers[48];

static uint32_t countdown_delay;


uint32_t s_to_ms(uint32_t s){return s*1000UL;}

void state_machine_init(char data_blob[64]){
	char temp[8];
	memcpy(numbers, data_blob, 48);
	memcpy(pin, data_blob + 48, 8);
	memcpy(temp, data_blob + 56, 8);
	countdown_delay = strtol(temp,NULL,10);


	pin[pin_len] = '#';
	countdown_delay = s_to_ms(COUNTDOWN_SECOND);

}

void state_machine_run(char input, bool changed_inp){
	if(changed_inp){
		changed = true;
		str[len++] = input;
	}
	switch(state){
	case DISARMED:
		state_machine_disarmed();
	  break;
	case ARMED:
		state_machine_armed();
	  break;
	case ARMED_COUNTDOWN:
		state_machine_countdown();
	  break;
	case ALERT_SMS:
		state_machine_alert();
	  break;
	case MENAGE_NUMBER:
	  break;
	case REMOVE_NUMBER:
	  break;
	case ADD_NUMBER:
	  break;
	case SET_ALERT_TIME:
		state_machine_set_alert_time();
	  break;
	case SET_NEW_PIN:
	  break;
	}
}

void state_machine_armed(void){
	GPIO_PinState singal_state = HAL_GPIO_ReadPin(Alarm_Signal_GPIO_Port, Alarm_Signal_Pin);
	if(changed == true || !singal_state || HAL_GetTick() - timestamp > TIME_PER_SYMBOL){
		if(len == 0 && changed){
			changed = false;
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string ("ARMED");
			lcd_put_cur(1, 0);
			lcd_send_string("PIN TO DISARM");
		}
		else if(!singal_state){
			state = ARMED_COUNTDOWN;
			memset(str,0,14);
			len = 0;
			changed = true;
			countdown_start = HAL_GetTick();
		}
		else if(len != 0){
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string("DISARM");
			lcd_put_cur(1, 0);
			str[len] = '\0';
			lcd_send_string(str);
			if(strcmp(str,pin) == 0){
				state = DISARMED;
				memset(str,0,14);
				len = 0;
				changed = true;
			}
			else if(str[len - 1] == '#' || len == 14 || !changed){
				lcd_clear();
				lcd_put_cur(0, 0);
				lcd_send_string ("WRONG PIN");
				memset(str,0,14);
				len = 0;
				changed = true;
				HAL_Delay(3000);
			}
			else{
				timestamp = HAL_GetTick();
				changed = false;
			}

		}

	}
}

void state_machine_disarmed(void){
	if(changed == true || HAL_GetTick() - timestamp > TIME_PER_SYMBOL){
	  if(len == 0 && changed){
		  changed = false;
		  lcd_clear();
		  lcd_put_cur(0, 0);
		  lcd_send_string ("DISARMED");
		  lcd_put_cur(1, 0);
		  lcd_send_string("PIN TO ARM");
	  }
	  else if(len != 0){
		  lcd_clear();
		  lcd_put_cur(0, 0);
		  lcd_send_string("DISARMED PIN");
		  lcd_put_cur(1, 0);
		  str[len] = '\0';
		  lcd_send_string(str);
		  if(strcmp(str,pin) == 0){
			  state = ARMED;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(strcmp(str,set_new_pin) == 0){
			  state = SET_NEW_PIN;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(strcmp(str,set_alert_time) == 0){
			  state = SET_ALERT_TIME;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(strcmp(str,menage_number) == 0){
			  state = MENAGE_NUMBER;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(str[len - 1] == '#' || len == 14 || !changed){
			  lcd_clear();
			  lcd_put_cur(0, 0);
			  lcd_send_string ("WRONG PIN");
			  memset(str,0,14);
			  len = 0;
			  changed = true;
			  HAL_Delay(3000);

		  }
		  else{
			  timestamp = HAL_GetTick();
			  changed = false;
		  }
	  }
	}
}

void state_machine_countdown(void){
	if(HAL_GetTick() - countdown_start > countdown_delay){
		state = ALERT_SMS;
		memset(str,0,14);
		len = 0;
		changed = true;
	}
	if(changed == true || HAL_GetTick() - timestamp > TIME_PER_SYMBOL || HAL_GetTick() - timestamp_display_s > 1000){
		if(len == 0 && (changed || HAL_GetTick() - timestamp_display_s > 1000)){
			timestamp_display_s = HAL_GetTick();
			changed = false;
			lcd_clear();
			lcd_put_cur(0, 0);
			char buf[14];
			snprintf(buf, 14 ,"COUNTDOWN %lu s",(uint32_t)(countdown_delay/1000 - (HAL_GetTick() - countdown_start)/1000));
			lcd_send_string (buf);
			lcd_put_cur(1, 0);
			lcd_send_string("PIN TO DISARM");
		}
		else if(len != 0 && (HAL_GetTick() - timestamp > TIME_PER_SYMBOL || changed)){
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string("DISARM");
			lcd_put_cur(1, 0);
			str[len] = '\0';
			lcd_send_string(str);
			if(strcmp(str,pin) == 0){
				state = DISARMED;
				memset(str,0,14);
				len = 0;
				changed = true;
			}
			else if(str[len - 1] == '#' || len == 14 || !changed){
				lcd_clear();
				lcd_put_cur(0, 0);
				lcd_send_string ("WRONG PIN");
				memset(str,0,14);
				len = 0;
				changed = true;
				HAL_Delay(3000);
			}
			else{
				timestamp = HAL_GetTick();
				changed = false;
			}
		}
	}

}


void state_machine_alert(void){

	//TODO GSM SEND
	state = ARMED;
	memset(str,0,14);
	len = 0;
	changed = true;
}

void state_machine_set_alert_time(void){
	if(changed == true){
		if(len == 0 && changed){
			changed = false;
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string ("SET TIME(S),#=SAVE");
		}
		else if(len != 0){
			lcd_put_cur(1, 0);
			lcd_send_string(str);
			if(str[len - 1] == '#'){
				countdown_delay = s_to_ms(strtol(str, NULL, 10));
				state = DISARMED;
				memset(str,0,14);
				len = 0;
				changed = true;
			}
		}
	}
}
