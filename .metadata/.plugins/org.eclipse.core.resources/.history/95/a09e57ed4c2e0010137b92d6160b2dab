/*
 * state_machine.c
 *
 *  Created on: May 11, 2025
 *      Author: axeel
 */

#include "state_machine.h"
#include <string.h>

static bool changed = true;
static char str[14];
static uint8_t len;


static uint32_t timestamp = 0;
static uint32_t countdown_start = 0;

static char* set_alert_time = "****";
static char* set_new_pin = "####";
static char* menage_number = "#*#*";
static char pin[16] = "";



void state_machine_init(uint8_t pin_len, char pin_inp[static pin_len]){
	memcpy(pin, pin_inp, pin_len);
	pin[pin_len] = '#';

}

void state_machine_run(char input, bool changed_inp){
	if(changed_inp){
		changed = true;
		str[len++] = input;
	}
	switch(state){
	case DISARMED:
		state_machine_disarmed();
	  break;
	case ARMED:
		state_machine_armed();
	  break;
	case ARMED_COUNTDOWN:
		state_machine_countdown();
	  break;
	case ALERT_SMS:
	  break;
	case MENAGE_NUMBER:
	  break;
	case REMOVE_NUMBER:
	  break;
	case ADD_NUMBER:
	  break;
	case SET_ALERT_TIME:
	  break;
	case SET_NEW_PIN:
	  break;
	}
}

void state_machine_armed(void){
	GPIO_PinState singal_state = HAL_GPIO_ReadPin(Alarm_Signal_GPIO_Port, Alarm_Signal_Pin);
	if(changed == true || !singal_state || HAL_GetTick() - timestamp > TIME_PER_SYMBOL){
		if(len == 0 && changed){
			changed = false;
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string ("ARMED");
			lcd_put_cur(1, 0);
			lcd_send_string("PIN TO DISARM");
		}
		else if(!singal_state){
			state = ARMED_COUNTDOWN;
			memset(str,0,14);
			len = 0;
			changed = true;
			countdown_start = HAL_GetTick();
		}
		else if(len != 0){
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string("DISARM");
			lcd_put_cur(1, 0);
			str[len] = '\0';
			lcd_send_string(str);
			if(strcmp(str,pin) == 0){
				state = DISARMED;
				memset(str,0,14);
				len = 0;
				changed = true;
			}
			else if(str[len - 1] == '#' || len == 14 || !changed){
				lcd_clear();
				lcd_put_cur(0, 0);
				lcd_send_string ("WRONG PIN");
				memset(str,0,14);
				len = 0;
				changed = true;
				HAL_Delay(3000);
			}
			else{
				timestamp = HAL_GetTick();
				changed = false;
			}

		}

	}
}

void state_machine_disarmed(void){
	if(changed == true || HAL_GetTick() - timestamp > TIME_PER_SYMBOL){
	  if(len == 0 && changed){
		  changed = false;
		  lcd_clear();
		  lcd_put_cur(0, 0);
		  lcd_send_string ("DISARMED");
		  lcd_put_cur(1, 0);
		  lcd_send_string("PIN TO ARM");
	  }
	  else if(len != 0){
		  lcd_clear();
		  lcd_put_cur(0, 0);
		  lcd_send_string("DISARMED PIN");
		  lcd_put_cur(1, 0);
		  str[len] = '\0';
		  lcd_send_string(str);
		  if(strcmp(str,pin) == 0){
			  state = ARMED;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(strcmp(str,set_new_pin) == 0){
			  state = SET_NEW_PIN;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(strcmp(str,set_alert_time) == 0){
			  state = SET_ALERT_TIME;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(strcmp(str,menage_number) == 0){
			  state = MENAGE_NUMBER;
			  memset(str,0,14);
			  len = 0;
			  changed = true;
		  }
		  else if(str[len - 1] == '#' || len == 14 || !changed){
			  lcd_clear();
			  lcd_put_cur(0, 0);
			  lcd_send_string ("WRONG PIN");
			  memset(str,0,14);
			  len = 0;
			  changed = true;
			  HAL_Delay(3000);

		  }
		  else{
			  timestamp = HAL_GetTick();
			  changed = false;
		  }
	  }
	}
}

void state_machine_countdown(void){
	if(HAL_GetTick() - countdown_start > COUNTDOWN_MS)
	if(changed == true || HAL_GetTick() - timestamp > TIME_PER_SYMBOL){
		if(len == 0 && changed){
			changed = false;
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string ("COUNTDOWN");
			lcd_put_cur(1, 0);
			lcd_send_string("PIN TO DISARM");
		}
		else if(len != 0){
			lcd_clear();
			lcd_put_cur(0, 0);
			lcd_send_string("DISARM");
			lcd_put_cur(1, 0);
			str[len] = '\0';
			lcd_send_string(str);
			if(strcmp(str,pin) == 0){
				state = DISARMED;
				memset(str,0,14);
				len = 0;
				changed = true;
			}
			else if(str[len - 1] == '#' || len == 14 || !changed){
				lcd_clear();
				lcd_put_cur(0, 0);
				lcd_send_string ("WRONG PIN");
				memset(str,0,14);
				len = 0;
				changed = true;
				HAL_Delay(3000);
			}
			else{
				timestamp = HAL_GetTick();
				changed = false;
			}
		}
	}

}
